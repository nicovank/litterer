name: CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  macos-clang-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - id: cwhy
        name: Set up CWhy
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cwhy
          python3 -m cwhy --version

      - name: Configure CMake
        run: >
          cmake . -B build 
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_C_COMPILER="$(python3 -m cwhy --wrapper --- clang)"
          -DCMAKE_CXX_COMPILER="$(python3 -m cwhy --wrapper --- clang++)"
        env:
          CWHY_DISABLE: 1

      - name: Build
        run: cmake --build build --parallel

  windows-msvc-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Print MSVC version
        run: |
          cl
          Get-Command cl

      - name: Set up Ninja
        run: choco install ninja

      - id: cwhy
        name: Set up CWhy
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cwhy

      - name: Configure CMake
        run: >
          cmake . -B build -G Ninja
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_C_COMPILER="$(python3 -m cwhy --wrapper --- cl)"
          -DCMAKE_CXX_COMPILER="$(python3 -m cwhy --wrapper --- cl)"
        env:
          CWHY_DISABLE: 1

      - name: Build
        run: cmake --build build --parallel

  ubuntu-gcc-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download GCC
        run: sudo apt install -y gcc-11 g++-11

      - id: cwhy
        name: Set up CWhy
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cwhy
          python3 -m cwhy --version

      - name: Configure CMake (GCC)
        run: >
          cmake . -B build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_C_COMPILER="$(python3 -m cwhy --wrapper --- gcc-11)"
          -DCMAKE_CXX_COMPILER="$(python3 -m cwhy --wrapper --- g++-11)"
        env:
          CWHY_DISABLE: 1

      - name: Build
        run: cmake --build build --parallel

  ubuntu-clang-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download LLVM
        run: |
          sudo apt install lsb-release wget software-properties-common gnupg
          curl -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 17 all

      - id: cwhy
        name: Set up CWhy
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cwhy
          python3 -m cwhy --version

      - name: Configure CMake (Clang)
        run: >
          cmake . -B build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DCMAKE_C_COMPILER="$(python3 -m cwhy --wrapper --- clang-17)"
          -DCMAKE_CXX_COMPILER="$(python3 -m cwhy --wrapper --- clang++-17)"
        env:
          CWHY_DISABLE: 1

      - name: Build
        run: cmake --build build --parallel

      - name: Check clang-format
        if: ${{ matrix.build-type == 'Debug' }}
        run: find src -name '*.cpp' -o -name '*.hpp'  | xargs clang-format-17 --dry-run --Werror

      - name: Check clang-tidy
        if: ${{ matrix.build-type == 'Debug' }}
        run: find src -name '*.cpp' | xargs clang-tidy-17 -p build --warnings-as-errors='*'
