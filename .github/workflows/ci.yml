name: CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  macos-clang-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4.1.1

      - id: cwhy
        name: Set up CWhy
        run: |
          echo "CWHY_VERSION=$(cwhy --version)" >> "$GITHUB_OUTPUT"
          echo "CC=$(cwhy --wrapper --- clang)"
          echo "CXX=$(cwhy --wrapper --- clang++)"

      - name: Configure CMake
        run: >
          cmake . -B build 
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
        env:
          CWHY_DISABLE: 1
          CC: ${{ steps.cwhy.outputs.CC }}
          CXX: ${{ steps.cwhy.outputs.CXX }}

      - name: Build
        run: cmake --build build --parallel

  windows-msvc-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Set up CWhy
        run: |
          echo "CWHY_VERSION=$(cwhy --version)" >> "$GITHUB_OUTPUT"
          echo "CC=$(cwhy --wrapper --- cl)"
          echo "CXX=$(cwhy --wrapper --- cl)"

      - name: Configure CMake
        run: >
          cmake . -B build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}

        env:
          CWHY_DISABLE: 1
          CC: ${{ steps.cwhy.outputs.CC }}
          CXX: ${{ steps.cwhy.outputs.CXX }}

      - name: Build
        run: cmake --build build --parallel

  ubuntu-gcc-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Download GCC
        run: sudo apt install -y gcc-11 g++-11

      - name: Set up CWhy
        run: |
          echo "CWHY_VERSION=$(cwhy --version)" >> "$GITHUB_OUTPUT"
          echo "CC=$(cwhy --wrapper --- gcc-11)"
          echo "CXX=$(cwhy --wrapper --- g++-11)"

      - name: Configure CMake (GCC)
        run: >
          cmake . -B build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}

        env:
          CWHY_DISABLE: 1
          CC: ${{ steps.cwhy.outputs.CC }}
          CXX: ${{ steps.cwhy.outputs.CXX }}

      - name: Build
        run: cmake --build build --parallel

  ubuntu-clang-check:
    strategy:
      matrix:
        build-type: [Debug, Release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Download LLVM
        run: |
          sudo apt install lsb-release wget software-properties-common gnupg
          curl -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 17 all

      - name: Set up CWhy
        run: |
          echo "CWHY_VERSION=$(cwhy --version)" >> "$GITHUB_OUTPUT"
          echo "CC=$(cwhy --wrapper --- clang-17)"
          echo "CXX=$(cwhy --wrapper --- clang++-17)"

      - name: Configure CMake (Clang)
        run: >
          cmake . -B build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

        env:
          CWHY_DISABLE: 1
          CC: ${{ steps.cwhy.outputs.CC }}
          CXX: ${{ steps.cwhy.outputs.CXX }}

      - name: Build
        run: cmake --build build --parallel

      - name: Check clang-format
        if: ${{ matrix.build-type == 'Debug' }}
        run: find src -name '*.cpp' | xargs clang-format-17 --dry-run --Werror

      - name: Check clang-tidy
        if: ${{ matrix.build-type == 'Debug' }}
        run: find src -name '*.cpp' | xargs clang-tidy-17 -p build --warnings-as-errors='*'
